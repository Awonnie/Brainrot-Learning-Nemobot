<!DOCTYPE html>
<html>
<head>
    <title>üß† Brainrot Learning Chatbot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: auto;
            padding: 2rem;
            background-color: #f8f8ff;
        }
        h1 {
            color: #6A0DAD;
        }
        form {
            margin-top: 2rem;
        }
        textarea {
            width: 100%;
            height: 400px;
            margin-top: 1rem;
            white-space: pre-wrap;
        }
        input[type="file"] {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }
        button {
            padding: 0.7rem 1.2rem;
            background-color: #6A0DAD;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #5c0cb3;
        }
        audio {
            margin-top: 1rem;
            width: 100%;
        }
        #loading-section {
            display: none;
            margin-top: 2rem;
        }
        #progress-container {
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 1rem;
        }
        #progress-bar {
            height: 20px;
            width: 0%;
            background-color: #6A0DAD;
            transition: width 0.5s ease-in-out;
        }
        .download-link {
            display: inline-block;
            margin-top: 1rem;
            text-decoration: none;
            color: white;
            background-color: #6A0DAD;
            padding: 0.6rem 1rem;
            border-radius: 5px;
        }
        .download-link:hover {
            background-color: #5c0cb3;
        }
    </style>
</head>
<body>
    <h1>üß† Brainrot Learning Chatbot</h1>
    <p>Upload your lecture slides (PDF or PPTX), and get a conversation between a blur sotong & a chao mugger!</p>

    <form action="/brainrot_chatbot" method="post" enctype="multipart/form-data">
        <input type="file" name="pdf_file" accept=".pdf,.pptx" required>
        <button type="submit">Generate Conversation</button>
    </form>

    <div id="loading-section">
        <p style="font-weight: bold; color: #6A0DAD;">üåÄ Generating conversation and audio... please wait!</p>
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
    </div>

    {% if conversation %}
        <h2>üó£Ô∏è Generated Conversation</h2>
        <textarea readonly>
{% for line in conversation %}
{{ line.speaker }}: {{ line.text }}
{% endfor %}
        </textarea>

        <h3>üéß Listen to the Podcast</h3>
        <audio id="podcast-audio" controls autoplay>
            <source id="podcast-source" src="" type="audio/mp3">
            Your browser does not support the audio element.
        </audio>

        <a id="download-button" href="#" class="download-link" download>‚¨áÔ∏è Download Full Audio</a>
    {% endif %}

    <script>
        const form = document.querySelector('form');
        const loadingSection = document.getElementById('loading-section');
        const progressBar = document.getElementById('progress-bar');
    
        form.addEventListener('submit', () => {
            loadingSection.style.display = 'block';
            progressBar.style.width = '5%';
        });
    </script>
    
    {% if conversation %}
    <script>
        window.addEventListener('load', async () => {
            const audio = document.getElementById('podcast-audio');
            const source = document.getElementById('podcast-source');
            const downloadBtn = document.getElementById('download-button');
    
            try {
                progressBar.style.width = '40%';
    
                const response = await fetch('/generate_full_audio');
                const data = await response.json();
    
                progressBar.style.width = '70%';
    
                if (data.status === "success") {
                    const audioUrl = data.audio_file;
                    source.src = audioUrl;
                    audio.load();
    
                    // Wait for audio to load before playing
                    audio.oncanplaythrough = () => {
                        audio.play();
                    };
    
                    // Enable download
                    downloadBtn.href = audioUrl;
                    downloadBtn.style.display = 'inline-block';
    
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        loadingSection.style.display = 'none';
                    }, 1000);
                }
            } catch (err) {
                console.error("Audio generation failed:", err);
                loadingSection.innerHTML = "<p style='color: red;'>‚ùå Something went wrong. Please try again.</p>";
            }
        });
    </script>
    {% endif %}
    
</body>
</html>